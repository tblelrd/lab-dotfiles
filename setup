#!/usr/bin/bash

set -u
START=$(date +%s%3N)

NET_HOME="/cs/home/$USER"
BIN_DIR="$NET_HOME/usr/bin"

LINES=$(tput lines)
BOTTOM_LINES=$((LINES/4))

function print_bottom () {
  local text=$@
  
  printf "\e7" # Save cursor location
  # +1 because off by one error (cant be bothered looking up why).
  printf '\e[%s;%sr' "$((LINES-BOTTOM_LINES+1))" "$LINES" # New bottom scrollable region
  printf "\e[%s;1H" "$LINES"

  printf "\e[1;94m$text\e[0m\n"

  printf '\e[%s;%sr' "0" "$((LINES-BOTTOM_LINES))" # Old top scrollable region
  printf "\e8" # Restore cursor location
}

function update_script () {
  # Enter dotfiles directory
  print_bottom "[UPDATE] Entering dotfiles directory"
  pushd "$NET_HOME/dotfiles"

  print_bottom "[UPDATE] Fetching the remote"
  git fetch origin main

  local local_branch=$(git rev-parse main)
  local remote_branch=$(git rev-parse origin/main)

  if [[ $local_branch = $remote_branch ]]; then
    print_bottom "[UPDATE] Up to date"
  else
    print_bottom "[UPDATE] Updating"
    git pull origin main
    print_bottom "[UPDATE] Rerunning updated script"
    ./setup
    popd &> /dev/null
    exit
 fi
}

function init_script () {
  # Leave space for bottom lines
  for i in $(seq "$BOTTOM_LINES"); do
    printf "\n"
  done

  printf "\e7" # Save cursor location

  printf '\e[%s;%sr' "0" "$((LINES-BOTTOM_LINES))"

  printf "\e8" # Restore cursor location

  # Go back up the spaces made like 10 lines ago
  printf "\e[%sA" "$BOTTOM_LINES"
}

function deinit_script() {
  printf "\e7" # Save cursor location

  local i
  for i in $(seq "$BOTTOM_LINES"); do
    printf "\e[%s;1H" "$((LINES - i))"
    printf "\e[2K"
  done

  printf '\e[%s;%sr' "0" "$LINES"
  printf "\e8" # Restore cursor location
}

function download_dependencies () {
  print_bottom "[DEP] Downloading Dependencies"

  print_bottom "[DEP] Checking if starship exists"
  if ! command -v starship > /dev/null; then
    print_bottom "[DEP::Starship] Starship not installed, downloading"
    curl -sSOJ https://starship.rs/install.sh 
    chmod +x ./install.sh
    ./install.sh -b "$BIN_DIR" --yes
    rm ./install.sh
  else 
    print_bottom "[DEP] Skipping"
  fi

  print_bottom "[DEP] Checking if fastfetch exists"
  if [ ! -f "$BIN_DIR/fastfetch" ]; then
    print_bottom "[DEP::Fastfetch] Installing fastfetch"
    print_bottom "[DEP::Fastfetch] Cloning repository..."
    git clone --depth 1 https://github.com/fastfetch-cli/fastfetch.git fastfetch

    print_bottom "[DEP::Fastfetch] Starting Build"
    pushd fastfetch
    mkdir -p build/
    pushd build/
    cmake ..
    cmake --build . --target fastfetch "-j$(nproc)" 


    print_bottom "[DEP::Fastfetch] Moving binary to usr/bin"
    cp "$(pwd)/fastfetch" "$BIN_DIR/fastfetch"


    print_bottom "[DEP::Fastfetch] Cleaning up"
    popd 
    popd 
    rm -rf fastfetch
  else
    print_bottom "[DEP] Skipping"
  fi

  print_bottom "[DEP] Checking if neovim exists"
  if [ ! -f "$BIN_DIR/nvim" ]; then
    print_bottom "[DEP] Installing neovim"
    git clone -b "stable" --depth=1 "https://github.com/neovim/neovim" neovim
    pushd neovim
    print_bottom "[DEP::Neovim] Setting up make/cmake"
    make CMAKE_BUILD_TYPE=RelWithDebInfo CMAKE_INSTALL_PREFIX="$NET_HOME/usr"
    print_bottom "[DEP::Neovim] Installing to usr/bin"
    make install

    print_bottom "[DEP::Neovim] Cleaning up"
    popd
    rm -rf neovim
  else
    print_bottom "[DEP] Skipping"
  fi

  print_bottom "[DEP] Checking if fzf exists"
  if [ ! -f "$BIN_DIR/fzf" ]; then
    print_bottom "[DEP] Installing fzf"
    git clone "https://github.com/junegunn/fzf/" fzf
    pushd fzf
    print_bottom "[DEP::fzf] Setting up make"
    make
    print_bottom "[DEP::fzf] Compiling fzf"
    make install

    print_bottom "[DEP::fzf] Moving binary to usr/bin"
    cp "$(pwd)/bin/fzf" "$BIN_DIR/fzf"

    print_bottom "[DEP::fzf] Cleaning up"
    popd
    rm -rf fzf
  else
    print_bottom "[DEP] Skipping"
  fi

  print_bottom "[DEP] Checking if eza exists"
  if [ ! -f "$BIN_DIR/eza" ]; then
    print_bottom "[DEP] Installing eza"
    git clone "https://github.com/eza-community/eza.git"
    pushd eza
    print_bottom "[DEP::eza] Compiling eza"
    cargo install --path . --root "$NET_HOME/usr"

    print_bottom "[DEP::eza] Cleaning up"
    popd
    rm -rf eza
  else
    print_bottom "[DEP] Skipping"
  fi

  print_bottom "[DEP] Checking if zoxide exists"
  if [ ! -f "$BIN_DIR/zoxide" ]; then
    print_bottom "[DEP] Installing zoxide"

    curl -sSOJ https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh 
    chmod +x ./install.sh
    ./install.sh --bin-dir "$BIN_DIR"
    rm ./install.sh

    print_bottom "[DEP::zoxide] Cleaning up"
    popd
    rm -rf 
  else
    print_bottom "[DEP] Skipping"
  fi

  print_bottom "[DEP::Configuration] Configuring Fastfetch"
  mkdir -p ~/.config/fastfetch
  ln -sf $NET_HOME/dotfiles/configs/fastfetch.jsonc $HOME/.config/fastfetch/config.jsonc

  print_bottom "[DEP::Configuration] Configuring Fish"
  mkdir -p ~/.config/fish
  ln -sf $NET_HOME/dotfiles/fish/config.fish $HOME/.config/fish/config.fish

  print_bottom "[DEP::Configuration] Configuring Starship"
  ln -sf $NET_HOME/dotfiles/configs/starship.toml $HOME/.config/starship.toml

  print_bottom "[DEP::Configuration] Configuring Neovim"
  ln -sf "$NET_HOME/dotfiles/configs/nvim" $HOME/.config/nvim

  print_bottom "[DEP::Configuration] Configuring Zsh"
  ln -sf $NET_HOME/dotfiles/configs/.zshrc $HOME/.zshrc
  ln -sf $NET_HOME/dotfiles/configs/.p10k.zsh $HOME/.p10k.zsh
}

function link_script () {
  print_bottom "[SETUP] Making sure that this script is in the bin folder"
  ln -sf "$NET_HOME/dotfiles/setup" "$NET_HOME/usr/bin"
}

function main () {
  trap deinit_script exit # Yeah
  trap deinit_script SIGINT # Yeah
  init_script

  update_script

  link_script

  # Dependencies
  download_dependencies

  print_bottom "[LOG] All done!"

  TIME=$(("$(date +%s%3N)" - START))
  printf "\nDone in \e[1;93m${TIME}ms!\e[0m\n"

  print_bottom "\e[1;90;107m[LOG] Press any key to exit..."
  read -n 1 -s -r
}

main 
